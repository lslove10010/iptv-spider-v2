<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>万人骑IPTV工具 v2.0 (复刻版)</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <style>
        body { font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', sans-serif; background-color: #f5f7fa; padding: 20px; }
        .main-card { max-width: 1000px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .log-box { 
            background: #fdfdfd; 
            border: 1px solid #e4e7ed; 
            height: 400px; 
            overflow-y: auto; 
            padding: 10px; 
            margin-top: 20px; 
            font-family: Consolas, monospace; 
            font-size: 14px;
            color: #606266;
            border-radius: 4px;
        }
        .log-item { margin-bottom: 4px; }
        .status-running { color: #67c23a; }
        .status-stopped { color: #909399; }
        .toolbar { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; background: #f5f7fa; padding: 15px; border-radius: 4px;}
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h2>万人骑IPTV工具 <small style="font-size: 0.5em; color: #999">v2.0 (Open Source Edition)</small></h2>
        </div>

        <div class="main-card">
            <el-tabs v-model="activeTab">
                <el-tab-pane label="采集" name="collection">
                    
                    <h3>数据采集设置</h3>
                    <div class="toolbar">
                        <span>API:</span>
                        <el-select v-model="form.apiType" placeholder="请选择" style="width: 150px">
                            <el-option label="组播 (Multicast)" value="multicast"></el-option>
                            <el-option label="单播 (Unicast)" value="unicast"></el-option>
                        </el-select>

                        <span>页数:</span>
                        <el-input-number v-model="form.pageCount" :min="1" :max="100"></el-input-number>

                        <span>开始日期:</span>
                        <el-date-picker v-model="form.startDate" type="date" placeholder="选择日期" value-format="YYYY-MM-DD"></el-date-picker>

                        <el-button type="primary" :loading="running" @click="startTask" :disabled="running">
                            {{ running ? '正在采集...' : '正在采集...' }} </el-button>
                        <el-button type="danger" @click="stopTask" :disabled="!running">停止采集</el-button>
                    </div>

                    <el-alert v-if="running" title="采集正在进行中，请稍后..." type="success" :closable="false" style="margin-top: 20px"></el-alert>

                    <h3>运行日志:</h3>
                    <div class="log-box" ref="logContainer">
                        <div v-for="(log, index) in logs" :key="index" class="log-item">
                            {{ log }}
                        </div>
                    </div>

                </el-tab-pane>
                <el-tab-pane label="IP管理" name="ip_manage">IP管理功能开发中...</el-tab-pane>
                <el-tab-pane label="设置" name="settings">系统设置开发中...</el-tab-pane>
            </el-tabs>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        const { createApp, ref, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const activeTab = ref('collection');
                const running = ref(false);
                const logs = ref([]);
                const logContainer = ref(null);
                const form = ref({
                    apiType: 'multicast',
                    pageCount: 2,
                    startDate: new Date().toISOString().split('T')[0]
                });

                let pollTimer = null;

                // 轮询日志
                const pollLogs = async () => {
                    try {
                        const res = await axios.get('http://127.0.0.1:8000/api/logs');
                        logs.value = res.data.logs;
                        running.value = res.data.running;
                        
                        // 自动滚动到底部
                        nextTick(() => {
                            if (logContainer.value) {
                                logContainer.value.scrollTop = logContainer.value.scrollHeight;
                            }
                        });
                    } catch (e) {
                        console.error("连接后端失败");
                    }
                };

                const startTask = async () => {
                    try {
                        await axios.post('http://127.0.0.1:8000/api/start', {
                            api_type: form.value.apiType,
                            page_count: form.value.pageCount,
                            start_date: form.value.startDate
                        });
                        running.value = true;
                        pollTimer = setInterval(pollLogs, 1000);
                    } catch (e) {
                        alert("启动失败");
                    }
                };

                const stopTask = async () => {
                    await axios.post('http://127.0.0.1:8000/api/stop');
                    // 不立即清除定时器，等待最后一次状态更新
                };

                return { activeTab, form, running, logs, startTask, stopTask, logContainer };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
